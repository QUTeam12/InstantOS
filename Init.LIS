                         4 .list
                         5 ***************************************************************
                         6 ** 各種レジスタ定義
                         7 ***************************************************************
                         8 ***************
                         9 ** レジスタ群の先頭
                        10 ***************
                        11 .equ REGBASE, 0xFFF000 | DMAP を使用．
                        12 .equ IOBASE, 0x00d00000
                        13 ***************
                        14 ** 割り込み関係のレジスタ
                        15 ***************
                        16 .equ IVR, REGBASE+0x300 | 割り込みベクタレジスタ
                        17 .equ IMR, REGBASE+0x304 | 割り込みマスクレジスタ
                        18 .equ ISR, REGBASE+0x30c | 割り込みステータスレジスタ
                        19 .equ IPR, REGBASE+0x310 | 割り込みペンディングレジスタ
                        20 ***************
                        21 ** タイマ関係のレジスタ
                        22 ***************
                        23 .equ TCTL1, REGBASE+0x600 | タイマ１コントロールレジスタ
                        24 .equ TPRER1, REGBASE+0x602 | タイマ１プリスケーラレジスタ
                        25 .equ TCMP1, REGBASE+0x604 | タイマ１コンペアレジスタ
                        26 .equ TCN1, REGBASE+0x608 | タイマ１カウンタレジスタ
                        27 .equ TSTAT1, REGBASE+0x60a | タイマ１ステータスレジスタ
                        28 ***************
                        29 ** UART1（送受信）関係のレジスタ
                        30 ***************
                        31 .equ USTCNT1, REGBASE+0x900 | UART1 ステータス/コントロールレジスタ
                        32 .equ UBAUD1, REGBASE+0x902 | UART1 ボーコントロールレジスタ
                        33 .equ URX1, REGBASE+0x904 | UART1 受信レジスタ
                        34 .equ UTX1, REGBASE+0x906 | UART1 送信レジスタ
                        35 ***************
                        36 ** LED
                        37 ***************
                        38 .equ LED7, IOBASE+0x000002f | ボード搭載の LED 用レジスタ
                        39 .equ LED6, IOBASE+0x000002d | 使用法については付録 A.4.3.1
                        40 .equ LED5, IOBASE+0x000002b
                        41 .equ LED4, IOBASE+0x0000029
                        42 .equ LED3, IOBASE+0x000003f
                        43 .equ LED2, IOBASE+0x000003d
                        44 .equ LED1, IOBASE+0x000003b
                        45 .equ LED0, IOBASE+0x0000039
                        46 **************
                        47 ** 推奨値
                        48 **************
                        49 .equ Mask_None,       0xFF3FFF
                        50 .equ Mask_UART1,      0xFF3FFB
                        51 .equ Mask_UART1_Timer,0xFF3FF9
                        52 **Timer
                        53 
                        54 **UART1
                        55 .equ U_Reset,   0x0000
                        56 .equ U_Putpull, 0xE100
                        57 .equ U_Putonly, 0xE108
                        58 .equ U_Pullonly,0xE10C
                        59 ***************************************************************
                        60 ** スタック領域の確保
                        61 ***************************************************************
                        62 .section .bss
                        63 .even
000488 0000 0000        64 SYS_STK:.ds.b 0x4000 | システムスタック領域
       0000 0000        64 
       0000 0000        64 
       0000 0000        64 
       0000 0000        64 
                        65 .even
                        66 SYS_STK_TOP: | システムスタック領域の最後尾
                        67 ***************************************************************
                        68 ** 初期化
                        69 ** 内部デバイスレジスタには特定の値が設定されている．
                        70 ** その理由を知るには，付録 B にある各レジスタの仕様を参照すること．
                        71 ***************************************************************
                        72 .section .text
                        73 .even
                        74 boot: * スーパーバイザ & 各種設定を行っている最中の割込禁止
000400 46FC 2700        75 move.w #0x2700,%SR
000404 4FF9 0000        76 lea.l SYS_STK_TOP, %SP | Set SSP
       0000             76 
                        77 ****************
                        78 ** 割り込みコントローラの初期化
                        79 ****************
00040a 13FC 0040        80 move.b #0x40, IVR | ユーザ割り込みベクタ番号を0x40+level に設定．
       00FF F300        80 
000412 21FC 0000        81 move.l #sousin ,0x110
       0000 0110        81 
00041a 23FC 00FF        82 move.l #Mask_UART1,IMR | 送受信割り込み許可
       3FFB 00FF        82 
       F304             82 
                        83 ****************
                        84 ** 送受信 (UART1) 関係の初期化 (割り込みレベルは 4 に固定されている)
                        85 ****************
000424 33FC 0000        86 move.w #U_Reset, USTCNT1 | リセット
       00FF F900        86 
00042c 33FC E10C        87 move.w #U_Pullonly, USTCNT1 |　受信割り込み許可
       00FF F900        87 
000434 33FC 0038        88 move.w #0x0038, UBAUD1 | baud rate = 230400 bps
       00FF F902        88 
                        89 ****************
                        90 ** タイマ関係の初期化 (割り込みレベルは 6 に固定されている)
                        91 *****************
00043c 33FC 0004        92 move.w #0x0004, TCTL1 | restart, 割り込み不可,
       00FF F600        92 
                        93 | システムクロックの 1/16 を単位として計時，a
                        94 | タイマ使用停止
                        95 **スタックレジスタ操作
000444 46FC 1000        96 move.w #0x1000, %SR
000448 33FC 0862        97 move.w #0x0800+'b',UTX1
       00FF F906        97 
000450 6000 0002        98 bra MAIN
                        99 ***************************************************************
                       100 **現段階での初期化ルーチンの正常動作を確認するため，最後に ’a’ を
                       101 **送信レジスタ UTX1 に書き込む．’a’ が出力されれば，OK.
                       102 ***************************************************************
                       103 .section .text
                       104 .even
                       105 MAIN:
000454 6000 FFFE       106 LOOP: bra LOOP
                       107 
                       108 interupt:
000458 48E7 7FFF       109 	movem.l %a0-%a7/%d1-%d7, -(%sp)
00045c 3039 00FF       110 	move.w URX1, %d0
       F904            110 
000462 0640 0800       111 	add.w #0x0800,%d0
000466 33C0 00FF       112 	move.w %d0,UTX1
       F906            112 
00046c 4CDF FFFE       113 	movem.l (%sp)+,%a0-%a7/%d1-%d7
000470 4E73            114 	rte
                       115 sousin:
000472 48E7 7FFF       116 	movem.l %a0-%a7/%d1-%d7, -(%sp)
000476 3239 00FF       117 	move.w UTX1,%d1
       F906            117 
00047c 13C1 00D0       118 	move.b %d1,LED0
       0039            118 
000482 4CDF FFFE       119 	movem.l (%sp)+,%a0-%a7/%d1-%d7
000486 4E73            120 	rte
