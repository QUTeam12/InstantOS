                         4 .list
                         5 ***************************************************************
                         6 ** 各種レジスタ定義
                         7 ***************************************************************
                         8 ***************
                         9 ** レジスタ群の先頭
                        10 ***************
                        11 .equ REGBASE, 0xFFF000 | DMAP を使用．
                        12 .equ IOBASE, 0x00d00000
                        13 ***************
                        14 ** 割り込み関係のレジスタ
                        15 ***************
                        16 .equ IVR, REGBASE+0x300 | 割り込みベクタレジスタ
                        17 .equ IMR, REGBASE+0x304 | 割り込みマスクレジスタ
                        18 .equ ISR, REGBASE+0x30c | 割り込みステータスレジスタ
                        19 .equ IPR, REGBASE+0x310 | 割り込みペンディングレジスタ
                        20 ***************
                        21 ** タイマ関係のレジスタ
                        22 ***************
                        23 .equ TCTL1, REGBASE+0x600 | タイマ１コントロールレジスタ
                        24 .equ TPRER1, REGBASE+0x602 | タイマ１プリスケーラレジスタ
                        25 .equ TCMP1, REGBASE+0x604 | タイマ１コンペアレジスタ
                        26 .equ TCN1, REGBASE+0x608 | タイマ１カウンタレジスタ
                        27 .equ TSTAT1, REGBASE+0x60a | タイマ１ステータスレジスタ
                        28 ***************
                        29 ** UART1（送受信）関係のレジスタ
                        30 ***************
                        31 .equ USTCNT1, REGBASE+0x900 | UART1 ステータス/コントロールレジスタ
                        32 .equ UBAUD1, REGBASE+0x902 | UART1 ボーコントロールレジスタ
                        33 .equ URX1, REGBASE+0x904 | UART1 受信レジスタ
                        34 .equ UTX1, REGBASE+0x906 | UART1 送信レジスタ
                        35 ***************
                        36 ** LED
                        37 ***************
                        38 .equ LED7, IOBASE+0x000002f | ボード搭載の LED 用レジスタ
                        39 .equ LED6, IOBASE+0x000002d | 使用法については付録 A.4.3.1
                        40 .equ LED5, IOBASE+0x000002b
                        41 .equ LED4, IOBASE+0x0000029
                        42 .equ LED3, IOBASE+0x000003f
                        43 .equ LED2, IOBASE+0x000003d
                        44 .equ LED1, IOBASE+0x000003b
                        45 .equ LED0, IOBASE+0x0000039
                        46 ***************************************************************
                        47 ** スタック領域の確保
                        48 ***************************************************************
                        49 .section .bss
                        50 .even
00046c 0000 0000        51 SYS_STK:.ds.b 0x4000 | システムスタック領域
       0000 0000        51 
       0000 0000        51 
       0000 0000        51 
       0000 0000        51 
                        52 .even
                        53 SYS_STK_TOP: | システムスタック領域の最後尾
                        54 ***************************************************************
                        55 ** 初期化
                        56 ** 内部デバイスレジスタには特定の値が設定されている．
                        57 ** その理由を知るには，付録 B にある各レジスタの仕様を参照すること．
                        58 ***************************************************************
                        59 .section .text
                        60 .even
                        61 boot: * スーパーバイザ & 各種設定を行っている最中の割込禁止
000400 46FC 2700        62 move.w #0x2700,%SR
000404 4FF9 0000        63 lea.l SYS_STK_TOP, %SP | Set SSP
       0000             63 
                        64 ****************
                        65 ** 割り込みコントローラの初期化
                        66 ****************
00040a 13FC 0040        67 move.b #0x40, IVR | ユーザ割り込みベクタ番号を0x40+level に設定．
       00FF F300        67 
000412 21FC 0000        68 move.l #interupt ,0x110
       0000 0110        68 
00041a 23FC 00FF        69 move.l #0x00ff3ffb,IMR | 送受信割り込み許可
       3FFB 00FF        69 
       F304             69 
                        70 ****************
                        71 ** 送受信 (UART1) 関係の初期化 (割り込みレベルは 4 に固定されている)
                        72 ****************
000424 33FC 0000        73 move.w #0x0000, USTCNT1 | リセット
       00FF F900        73 
00042c 33FC E108        74 move.w #0xe108, USTCNT1 |　受信割り込み許可
       00FF F900        74 
000434 33FC 0038        75 move.w #0x0038, UBAUD1 | baud rate = 230400 bps
       00FF F902        75 
                        76 ****************
                        77 ** タイマ関係の初期化 (割り込みレベルは 6 に固定されている)
                        78 *****************
00043c 33FC 0004        79 move.w #0x0004, TCTL1 | restart, 割り込み不可,
       00FF F600        79 
                        80 | システムクロックの 1/16 を単位として計時，a
                        81 | タイマ使用停止
                        82 **スタックレジスタ操作
000444 46FC 1000        83 move.w #0x1000, %SR
000448 6000 0002        84 bra MAIN
                        85 ***************************************************************
                        86 **現段階での初期化ルーチンの正常動作を確認するため，最後に ’a’ を
                        87 **送信レジスタ UTX1 に書き込む．’a’ が出力されれば，OK.
                        88 ***************************************************************
                        89 .section .text
                        90 .even
                        91 MAIN:
00044c 6000 FFFE        92 LOOP: bra LOOP
                        93 
                        94 interupt:
000450 48E7 7FFF        95 	movem.l %a0-%a7/%d1-%d7, -(%sp)
000454 3039 00FF        96 	move.w URX1, %d0
       F904             96 
00045a 0640 0800        97 	add.w #0x0800,%d0
00045e 33C0 00FF        98 	move.w %d0,UTX1
       F906             98 
000464 4CDF FFFE        99 	movem.l (%sp)+,%a0-%a7/%d1-%d7
000468 4E73            100 	rte
                       101 
